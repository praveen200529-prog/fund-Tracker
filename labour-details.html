<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labour Management - Fund Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, hsl(210, 37%, 49%) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ‘· Labour Management Module</h1>
            <button class="btn btn-danger" onclick="clearAllData()">Reset All Data</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('master')">Labour Master</button>
            <button class="tab" onclick="showTab('attendance')">Daily Attendance</button>
            <button class="tab" onclick="showTab('wages')">Wage Calculation</button>
            <button class="tab" onclick="showTab('payments')">Payments</button>
            <button class="tab" onclick="showTab('outstanding')">Outstanding</button>
            <button class="tab" onclick="showTab('summary')">Cost Summary</button>
        </div>

        <div class="content">
            <div id="message"></div>

            <!-- Labour Master Tab -->
            <div id="master" class="tab-content active">
                <h2 class="section-title">ðŸ“Œ A. Labour Master Table</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Labour Name *</label>
                        <input type="text" id="labourName" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label>Labour Type *</label>
                        <select id="labourType">
                            <option value="">Select Type</option>
                            <option value="Skilled">Skilled</option>
                            <option value="Unskilled">Unskilled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Trade *</label>
                        <select id="trade">
                            <option value="">Select Trade</option>
                            <option value="Welder">Welder</option>
                            <option value="Fitter">Fitter</option>
                            <option value="Electrician">Electrician</option>
                            <option value="Carpenter">Carpenter</option>
                            <option value="Mason">Mason</option>
                            <option value="Helper">Helper</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mobile No *</label>
                        <input type="tel" id="mobile" placeholder="10-digit number">
                    </div>
                    <div class="form-group">
                        <label>Daily Wage (â‚¹) *</label>
                        <input type="number" id="dailyWage" placeholder="Enter wage">
                    </div>
                    <div class="form-group">
                        <label>Contractor Name</label>
                        <input type="text" id="contractorName" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label>Joining Date *</label>
                        <input type="date" id="joiningDate">
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="status">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addLabour()">âž• Add Labour</button>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Labour ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Trade</th>
                                <th>Mobile</th>
                                <th>Daily Wage</th>
                                <th>Contractor</th>
                                <th>Joining Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="labourTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="tab-content">
                <h2 class="section-title">ðŸ“Œ B. Labour Attendance Table</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="attDate">
                    </div>
                    <div class="form-group">
                        <label>Project ID *</label>
                        <input type="text" id="attProjectId" placeholder="e.g., PRJ001">
                    </div>
                    <div class="form-group">
                        <label>Labour *</label>
                        <select id="attLabourId"></select>
                    </div>
                    <div class="form-group">
                        <label>Attendance *</label>
                        <select id="attStatus">
                            <option value="Present">Present</option>
                            <option value="Half Day">Half Day</option>
                            <option value="Absent">Absent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>OT Hours</label>
                        <input type="number" id="otHours" placeholder="0" value="0" min="0">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addAttendance()">âœ… Mark Attendance</button>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Project ID</th>
                                <th>Labour ID</th>
                                <th>Labour Name</th>
                                <th>Attendance</th>
                                <th>OT Hours</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Wages Tab -->
            <div id="wages" class="tab-content">
                <h2 class="section-title">ðŸ“Œ C. Labour Wage Calculation (Auto-Generated)</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Labour ID</th>
                                <th>Labour Name</th>
                                <th>Project ID</th>
                                <th>Month</th>
                                <th>Total Days</th>
                                <th>OT Hours</th>
                                <th>Wage Amount (â‚¹)</th>
                            </tr>
                        </thead>
                        <tbody id="wagesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <h2 class="section-title">ðŸ“Œ D. Labour Payment Table</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Payment Date *</label>
                        <input type="date" id="paymentDate">
                    </div>
                    <div class="form-group">
                        <label>Project ID *</label>
                        <input type="text" id="payProjectId" placeholder="e.g., PRJ001">
                    </div>
                    <div class="form-group">
                        <label>Labour *</label>
                        <select id="payLabourId"></select>
                    </div>
                    <div class="form-group">
                        <label>Payment Mode *</label>
                        <select id="paymentMode">
                            <option value="Cash">Cash</option>
                            <option value="Bank">Bank Transfer</option>
                            <option value="UPI">UPI</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount (â‚¹) *</label>
                        <input type="number" id="paymentAmount" placeholder="Enter amount">
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="paymentStatus">
                            <option value="Paid">Paid</option>
                            <option value="Partial">Partial</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addPayment()">ðŸ’° Add Payment</button>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Payment Date</th>
                                <th>Project ID</th>
                                <th>Labour ID</th>
                                <th>Labour Name</th>
                                <th>Payment Mode</th>
                                <th>Amount (â‚¹)</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Outstanding Tab -->
            <div id="outstanding" class="tab-content">
                <h2 class="section-title">ðŸ“Œ E. Labour Outstanding (Auto-Generated)</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Labour ID</th>
                                <th>Labour Name</th>
                                <th>Project ID</th>
                                <th>Total Payable (â‚¹)</th>
                                <th>Paid (â‚¹)</th>
                                <th>Balance (â‚¹)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="outstandingTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Summary Tab -->
            <div id="summary" class="tab-content">
                <h2 class="section-title">ðŸ“Œ F. Labour Cost Summary (Project-wise)</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Labour Cost</h3>
                        <div class="value" id="totalCost">â‚¹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Paid</h3>
                        <div class="value" id="totalPaid">â‚¹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Outstanding</h3>
                        <div class="value" id="totalOutstanding">â‚¹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Labours</h3>
                        <div class="value" id="activeLabours">0</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Project ID</th>
                                <th>Month</th>
                                <th>Total Labour Cost (â‚¹)</th>
                                <th>Paid (â‚¹)</th>
                                <th>Outstanding (â‚¹)</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data
        let labourData = [];
        let attendanceData = [];
        let paymentData = [];

        // Load data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllData();
            setDefaultDate();
            refreshAllTables();
        });

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attDate').value = today;
            document.getElementById('paymentDate').value = today;
            document.getElementById('joiningDate').value = today;
        }

        async function loadAllData() {
            try {
                // Load Labour Master
                const labourResult = await window.storage.get('labour_master');
                if (labourResult) {
                    labourData = JSON.parse(labourResult.value);
                }

                // Load Attendance
                const attendanceResult = await window.storage.get('labour_attendance');
                if (attendanceResult) {
                    attendanceData = JSON.parse(attendanceResult.value);
                }

                // Load Payments
                const paymentResult = await window.storage.get('labour_payments');
                if (paymentResult) {
                    paymentData = JSON.parse(paymentResult.value);
                }
            } catch (error) {
                console.log('No existing data found, starting fresh');
            }
        }

        async function saveLabourData() {
            try {
                await window.storage.set('labour_master', JSON.stringify(labourData));
            } catch (error) {
                showMessage('Error saving labour data', 'error');
            }
        }

        async function saveAttendanceData() {
            try {
                await window.storage.set('labour_attendance', JSON.stringify(attendanceData));
            } catch (error) {
                showMessage('Error saving attendance data', 'error');
            }
        }

        async function savePaymentData() {
            try {
                await window.storage.set('labour_payments', JSON.stringify(paymentData));
            } catch (error) {
                showMessage('Error saving payment data', 'error');
            }
        }

        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            refreshAllTables();
        }

        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        async function addLabour() {
            const name = document.getElementById('labourName').value.trim();
            const type = document.getElementById('labourType').value;
            const trade = document.getElementById('trade').value;
            const mobile = document.getElementById('mobile').value.trim();
            const wage = document.getElementById('dailyWage').value;
            const contractor = document.getElementById('contractorName').value.trim();
            const joiningDate = document.getElementById('joiningDate').value;
            const status = document.getElementById('status').value;

            if (!name || !type || !trade || !mobile || !wage || !joiningDate) {
                showMessage('Please fill all required fields', 'error');
                return;
            }

            if (mobile.length !== 10) {
                showMessage('Mobile number must be 10 digits', 'error');
                return;
            }

            const labourId = 'LBR' + String(labourData.length + 1).padStart(3, '0');

            const labour = {
                id: labourId,
                name,
                type,
                trade,
                mobile,
                dailyWage: parseFloat(wage),
                contractor,
                joiningDate,
                status
            };

            labourData.push(labour);
            await saveLabourData();
            
            // Clear form
            document.getElementById('labourName').value = '';
            document.getElementById('labourType').value = '';
            document.getElementById('trade').value = '';
            document.getElementById('mobile').value = '';
            document.getElementById('dailyWage').value = '';
            document.getElementById('contractorName').value = '';
            document.getElementById('status').value = 'Active';

            showMessage('Labour added successfully!');
            refreshAllTables();
        }

        async function deleteLabour(id) {
            if (confirm('Are you sure you want to delete this labour?')) {
                labourData = labourData.filter(l => l.id !== id);
                await saveLabourData();
                showMessage('Labour deleted successfully!');
                refreshAllTables();
            }
        }

        async function addAttendance() {
            const date = document.getElementById('attDate').value;
            const projectId = document.getElementById('attProjectId').value.trim();
            const labourId = document.getElementById('attLabourId').value;
            const status = document.getElementById('attStatus').value;
            const otHours = parseFloat(document.getElementById('otHours').value) || 0;

            if (!date || !projectId || !labourId) {
                showMessage('Please fill all required fields', 'error');
                return;
            }

            const attendance = {
                date,
                projectId,
                labourId,
                status,
                otHours
            };

            attendanceData.push(attendance);
            await saveAttendanceData();

            document.getElementById('attProjectId').value = '';
            document.getElementById('otHours').value = '0';

            showMessage('Attendance marked successfully!');
            refreshAllTables();
        }

        async function deleteAttendance(index) {
            if (confirm('Are you sure you want to delete this attendance record?')) {
                attendanceData.splice(index, 1);
                await saveAttendanceData();
                showMessage('Attendance deleted successfully!');
                refreshAllTables();
            }
        }

        async function addPayment() {
            const date = document.getElementById('paymentDate').value;
            const projectId = document.getElementById('payProjectId').value.trim();
            const labourId = document.getElementById('payLabourId').value;
            const mode = document.getElementById('paymentMode').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const status = document.getElementById('paymentStatus').value;

            if (!date || !projectId || !labourId || !amount) {
                showMessage('Please fill all required fields', 'error');
                return;
            }

            const payment = {
                date,
                projectId,
                labourId,
                mode,
                amount,
                status
            };

            paymentData.push(payment);
            await savePaymentData();

            document.getElementById('payProjectId').value = '';
            document.getElementById('paymentAmount').value = '';

            showMessage('Payment added successfully!');
            refreshAllTables();
        }

        async function deletePayment(index) {
            if (confirm('Are you sure you want to delete this payment?')) {
                paymentData.splice(index, 1);
                await savePaymentData();
                showMessage('Payment deleted successfully!');
                refreshAllTables();
            }
        }

        function calculateWages() {
            const wages = [];
            const labourWageMap = {};

            attendanceData.forEach(att => {
                const labour = labourData.find(l => l.id === att.labourId);
                if (!labour) return;

                const key = `${att.labourId}-${att.projectId}`;
                
                if (!labourWageMap[key]) {
                    labourWageMap[key] = {
                        labourId: att.labourId,
                        labourName: labour.name,
                        projectId: att.projectId,
                        totalDays: 0,
                        otHours: 0,
                        wageAmount: 0
                    };
                }

                if (att.status === 'Present') {
                    labourWageMap[key].totalDays += 1;
                } else if (att.status === 'Half Day') {
                    labourWageMap[key].totalDays += 0.5;
                }

                labourWageMap[key].otHours += att.otHours;
            });

            Object.values(labourWageMap).forEach(wage => {
                const labour = labourData.find(l => l.id === wage.labourId);
                if (labour) {
                    const basicWage = wage.totalDays * labour.dailyWage;
                    const otWage = wage.otHours * (labour.dailyWage / 8);
                    wage.wageAmount = basicWage + otWage;
                    wages.push(wage);
                }
            });

            return wages;
        }

        function calculateOutstanding() {
            const wages = calculateWages();
            const outstanding = [];

            wages.forEach(wage => {
                const payments = paymentData.filter(p => 
                    p.labourId === wage.labourId && p.projectId === wage.projectId
                );
                
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const balance = wage.wageAmount - totalPaid;

                outstanding.push({
                    labourId: wage.labourId,
                    labourName: wage.labourName,
                    projectId: wage.projectId,
                    totalPayable: wage.wageAmount,
                    paid: totalPaid,
                    balance: balance
                });
            });

            return outstanding;
        }

        function calculateSummary() {
            const summary = {};
            const wages = calculateWages();

            wages.forEach(wage => {
                const date = new Date();
                const month = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                const key = `${wage.projectId}-${month}`;

                if (!summary[key]) {
                    summary[key] = {
                        projectId: wage.projectId,
                        month: month,
                        totalCost: 0,
                        paid: 0,
                        outstanding: 0
                    };
                }

                summary[key].totalCost += wage.wageAmount;
            });

            paymentData.forEach(payment => {
                const date = new Date(payment.date);
                const month = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                const key = `${payment.projectId}-${month}`;

                if (summary[key]) {
                    summary[key].paid += payment.amount;
                }
            });

            Object.values(summary).forEach(s => {
                s.outstanding = s.totalCost - s.paid;
            });

            return Object.values(summary);
        }

        function refreshAllTables() {
            refreshLabourTable();
            refreshAttendanceTable();
            refreshWagesTable();
            refreshPaymentsTable();
            refreshOutstandingTable();
            refreshSummaryTable();
            updateLabourDropdowns();
        }

        function refreshLabourTable() {
            const tbody = document.getElementById('labourTableBody');
            tbody.innerHTML = '';

            labourData.forEach(labour => {
                const row = `
                    <tr>
                        <td>${labour.id}</td>
                        <td>${labour.name}</td>
                        <td>${labour.type}</td>
                        <td>${labour.trade}</td>
                        <td>${labour.mobile}</td>
                        <td>â‚¹${labour.dailyWage}</td>
                        <td>${labour.contractor || '-'}</td>
                        <td>${labour.joiningDate}</td>
                        <td><span class="badge badge-${labour.status === 'Active' ? 'success' : 'danger'}">${labour.status}</span></td>
                        <td><button class="btn btn-danger" onclick="deleteLabour('${labour.id}')">Delete</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function refreshAttendanceTable() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';

            attendanceData.forEach((att, index) => {
                const labour = labourData.find(l => l.id === att.labourId);
                const labourName = labour ? labour.name : 'Unknown';
                
                const row = `
                    <tr>
                        <td>${att.date}</td>
                        <td>${att.projectId}</td>
                        <td>${att.labourId}</td>
                        <td>${labourName}</td>
                        <td><span class="badge badge-${att.status === 'Present' ? 'success' : att.status === 'Half Day' ? 'warning' : 'danger'}">${att.status}</span></td>
                        <td>${att.otHours}</td>
                        <td><button class="btn btn-danger" onclick="deleteAttendance(${index})">Delete</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function refreshWagesTable() {
            const tbody = document.getElementById('wagesTableBody');
            tbody.innerHTML = '';
            
            const wages = calculateWages();
            const date = new Date();
            const month = date.toLocaleString('default', { month: 'short', year: 'numeric' });

            wages.forEach(wage => {
                const row = `
                    <tr>
                        <td>${wage.labourId}</td>
                        <td>${wage.labourName}</td>
                        <td>${wage.projectId}</td>
                        <td>${month}</td>
                        <td>${wage.totalDays}</td>
                        <td>${wage.otHours}</td>
                        <td>â‚¹${wage.wageAmount.toFixed(2)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function refreshPaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';

            paymentData.forEach((payment, index) => {
                const labour = labourData.find(l => l.id === payment.labourId);
                const labourName = labour ? labour.name : 'Unknown';
                
                const row = `
                    <tr>
                        <td>${payment.date}</td>
                        <td>${payment.projectId}</td>
                        <td>${payment.labourId}</td>
                        <td>${labourName}</td>
                        <td>${payment.mode}</td>
                        <td>â‚¹${payment.amount.toFixed(2)}</td>
                        <td><span class="badge badge-${payment.status === 'Paid' ? 'success' : payment.status === 'Partial' ? 'warning' : 'danger'}">${payment.status}</span></td>
                        <td><button class="btn btn-danger" onclick="deletePayment(${index})">Delete</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function refreshOutstandingTable() {
            const tbody = document.getElementById('outstandingTableBody');
            tbody.innerHTML = '';
            
            const outstanding = calculateOutstanding();

            outstanding.forEach(out => {
                const statusBadge = out.balance === 0 ? 'success' : out.balance > 0 ? 'warning' : 'danger';
                const statusText = out.balance === 0 ? 'Settled' : out.balance > 0 ? 'Outstanding' : 'Overpaid';
                
                const row = `
                    <tr>
                        <td>${out.labourId}</td>
                        <td>${out.labourName}</td>
                        <td>${out.projectId}</td>
                        <td>â‚¹${out.totalPayable.toFixed(2)}</td>
                        <td>â‚¹${out.paid.toFixed(2)}</td>
                        <td>â‚¹${out.balance.toFixed(2)}</td>
                        <td><span class="badge badge-${statusBadge}">${statusText}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function refreshSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';
            
            const summary = calculateSummary();
            let totalCost = 0;
            let totalPaid = 0;
            let totalOutstanding = 0;

            summary.forEach(sum => {
                totalCost += sum.totalCost;
                totalPaid += sum.paid;
                totalOutstanding += sum.outstanding;
                
                const row = `
                    <tr>
                        <td>${sum.projectId}</td>
                        <td>${sum.month}</td>
                        <td>â‚¹${sum.totalCost.toFixed(2)}</td>
                        <td>â‚¹${sum.paid.toFixed(2)}</td>
                        <td>â‚¹${sum.outstanding.toFixed(2)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update stat cards
            document.getElementById('totalCost').textContent = `â‚¹${totalCost.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `â‚¹${totalPaid.toFixed(2)}`;
            document.getElementById('totalOutstanding').textContent = `â‚¹${totalOutstanding.toFixed(2)}`;
            document.getElementById('activeLabours').textContent = labourData.filter(l => l.status === 'Active').length;
        }

        function updateLabourDropdowns() {
            const attDropdown = document.getElementById('attLabourId');
            const payDropdown = document.getElementById('payLabourId');
            
            attDropdown.innerHTML = '<option value="">Select Labour</option>';
            payDropdown.innerHTML = '<option value="">Select Labour</option>';

            labourData.filter(l => l.status === 'Active').forEach(labour => {
                const option = `<option value="${labour.id}">${labour.id} - ${labour.name}</option>`;
                attDropdown.innerHTML += option;
                payDropdown.innerHTML += option;
            });
        }

        async function clearAllData() {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
                try {
                    await window.storage.delete('labour_master');
                    await window.storage.delete('labour_attendance');
                    await window.storage.delete('labour_payments');
                    
                    labourData = [];
                    attendanceData = [];
                    paymentData = [];
                    
                    refreshAllTables();
                    showMessage('All data cleared successfully!');
                } catch (error) {
                    showMessage('Error clearing data', 'error');
                }
            }
        }
    </script>
</body>
</html>