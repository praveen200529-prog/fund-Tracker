<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Contractor Details - Fund Monitoring System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-back {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: #1e40af;
            transform: translateX(-5px);
        }

        .breadcrumb {
            color: #666;
            font-size: 14px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2563eb;
        }

        .section-header h2 {
            color: #2563eb;
            font-size: 22px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .data-table th {
            background: #2563eb;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            color: #333;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .form-toggle {
            display: none;
        }

        .form-toggle.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #2563eb;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 5px;
        }

        .stat-card .sub-text {
            font-size: 12px;
            color: #999;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .highlight-box {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2563eb;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            max-width: 1000px;
            margin: 50px auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .detail-item {
            padding: 10px;
            background: #f8fafc;
            border-radius: 5px;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <button class="btn-back" onclick="goBackToDashboard()">‚Üê Back to Dashboard</button>
            <div class="breadcrumb">
                <span>Dashboard</span> / <span style="color: #2563eb; font-weight: 600;">Super Contractor Management</span>
            </div>
        </div>

        <div class="header">
            <h1> Super Contractor Management System</h1>
            <p>Complete project control, fund monitoring, billing, quality, delay & profit tracking</p>
        </div>

        <!-- Project Overview Dashboard -->
        <div class="stats-grid" id="statsContainer">
            <div class="stat-card">
                <h3>Total Projects</h3>
                <div class="value" id="totalProjects">0</div>
                <div class="sub-text">Active contracts</div>
            </div>
            <div class="stat-card">
                <h3>Total Project Value</h3>
                <div class="value" id="totalProjectValue">‚Çπ0</div>
                <div class="sub-text">Combined value</div>
            </div>
            <div class="stat-card">
                <h3>Work Completed</h3>
                <div class="value" id="avgProgress">0%</div>
                <div class="sub-text">Average progress</div>
            </div>
            <div class="stat-card">
                <h3>Amount Billed</h3>
                <div class="value" id="totalBilled">‚Çπ0</div>
                <div class="sub-text">Total billed amount</div>
            </div>
            <div class="stat-card">
                <h3>Amount Paid</h3>
                <div class="value" id="totalPaid">‚Çπ0</div>
                <div class="sub-text">Total paid</div>
            </div>
            <div class="stat-card">
                <h3>Balance Payable</h3>
                <div class="value" id="balancePayable">‚Çπ0</div>
                <div class="sub-text">Pending payments</div>
            </div>
            <div class="stat-card">
                <h3>SC Profit/Margin</h3>
                <div class="value" style="color: #10b981;" id="totalProfit">‚Çπ0</div>
                <div class="sub-text">Estimated profit</div>
            </div>
            <div class="stat-card">
                <h3>Delay Days</h3>
                <div class="value" style="color: #ef4444;" id="avgDelay">0</div>
                <div class="sub-text">Average delay</div>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="section">
            <div class="tab-container">
                <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab" onclick="switchTab('contractors')">üë∑ Contractors</button>
                <button class="tab" onclick="switchTab('progress')">üìà Progress</button>
                <button class="tab" onclick="switchTab('billing')">üí∞ Billing</button>
                <button class="tab" onclick="switchTab('payments')">üí≥ Payments</button>
                <button class="tab" onclick="switchTab('quality')">‚úÖ Quality</button>
                <button class="tab" onclick="switchTab('materials')">üì¶ Materials</button>
                <button class="tab" onclick="switchTab('profitability')">üíπ Profitability</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="section-header">
                    <h2>üìä Projects Overview</h2>
                    <button class="btn btn-primary" onclick="toggleProjectForm()">+ Add New Project</button>
                </div>

                <div id="projectFormContainer" class="form-toggle">
                    <form id="projectForm">
                        <h3 style="color: #2563eb; margin-bottom: 15px;">üìã Basic Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Project Name *</label>
                                <input type="text" id="projectName" required>
                            </div>
                            <div class="form-group">
                                <label>Client Name *</label>
                                <input type="text" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label>Location *</label>
                                <input type="text" id="location" required>
                            </div>
                            <div class="form-group">
                                <label>Total Project Value (‚Çπ) *</label>
                                <input type="number" id="projectValue" required min="0">
                            </div>
                            <div class="form-group">
                                <label>Start Date *</label>
                                <input type="date" id="startDate" required>
                            </div>
                            <div class="form-group">
                                <label>Planned End Date *</label>
                                <input type="date" id="plannedEndDate" required>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="toggleProjectForm()" style="background: #ccc;">Cancel</button>
                            <button type="submit" class="btn btn-success">üíæ Save Project</button>
                        </div>
                    </form>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Client</th>
                                <th>Value</th>
                                <th>Progress</th>
                                <th>Billed</th>
                                <th>Paid</th>
                                <th>Balance</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr><td colspan="9" class="empty-state">No projects yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contractors Tab -->
            <div id="contractors" class="tab-content">
                <div class="section-header">
                    <h2>üë∑ Contractor Master</h2>
                    <button class="btn btn-primary" onclick="toggleContractorForm()">+ Add Contractor</button>
                </div>

                <div id="contractorFormContainer" class="form-toggle">
                    <form id="contractorForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Project *</label>
                                <select id="contractorProjectId" required></select>
                            </div>
                            <div class="form-group">
                                <label>Contractor Name *</label>
                                <input type="text" id="contractorName" required>
                            </div>
                            <div class="form-group">
                                <label>Work Category *</label>
                                <select id="workCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="Earthwork">Earthwork</option>
                                    <option value="RCC">RCC</option>
                                    <option value="Electrical">Electrical</option>
                                    <option value="Plumbing">Plumbing</option>
                                    <option value="Finishing">Finishing</option>
                                    <option value="Civil">Civil Works</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Agreement No *</label>
                                <input type="text" id="agreementNo" required>
                            </div>
                            <div class="form-group">
                                <label>Work Order Date *</label>
                                <input type="date" id="workOrderDate" required>
                            </div>
                            <div class="form-group">
                                <label>Contract Value (‚Çπ) *</label>
                                <input type="number" id="contractValue" required min="0">
                            </div>
                            <div class="form-group">
                                <label>Rate Type *</label>
                                <select id="rateType" required>
                                    <option value="Item Rate">Item Rate</option>
                                    <option value="Lumpsum">Lumpsum</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Retention % *</label>
                                <input type="number" id="retentionPercent" required min="0" max="100" value="5">
                            </div>
                            <div class="form-group">
                                <label>Penalty Clause % *</label>
                                <input type="number" id="penaltyPercent" required min="0" max="100" value="0.5">
                            </div>
                            <div class="form-group">
                                <label>Start Date *</label>
                                <input type="date" id="contractorStartDate" required>
                            </div>
                            <div class="form-group">
                                <label>End Date *</label>
                                <input type="date" id="contractorEndDate" required>
                            </div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="contractorStatus" required>
                                    <option value="Active">Active</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Terminated">Terminated</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="toggleContractorForm()" style="background: #ccc;">Cancel</button>
                            <button type="submit" class="btn btn-success">üíæ Save Contractor</button>
                        </div>
                    </form>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Contractor</th>
                                <th>Project</th>
                                <th>Category</th>
                                <th>Contract Value</th>
                                <th>Agreement No</th>
                                <th>Retention %</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contractorsTableBody">
                            <tr><td colspan="8" class="empty-state">No contractors yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Progress Tab -->
            <div id="progress" class="tab-content">
                <div class="section-header">
                    <h2>üìà Work Progress Monitoring</h2>
                    <button class="btn btn-primary" onclick="toggleProgressForm()">+ Add Progress Entry</button>
                </div>

                <div id="progressFormContainer" class="form-toggle">
                    <form id="progressForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Contractor *</label>
                                <select id="progressContractorId" required></select>
                            </div>
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" id="progressDate" required>
                            </div>
                            <div class="form-group">
                                <label>Item Description *</label>
                                <input type="text" id="itemDescription" required>
                            </div>
                            <div class="form-group">
                                <label>Unit *</label>
                                <select id="unit" required>
                                    <option value="Cum">Cum</option>
                                    <option value="Sqm">Sqm</option>
                                    <option value="Nos">Nos</option>
                                    <option value="RM">RM (Running Meter)</option>
                                    <option value="MT">MT (Metric Ton)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Agreed Quantity *</label>
                                <input type="number" id="agreedQty" required min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Executed Quantity *</label>
                                <input type="number" id="executedQty" required min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="toggleProgressForm()" style="background: #ccc;">Cancel</button>
                            <button type="submit" class="btn btn-success">üíæ Save Progress</button>
                        </div>
                    </form>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Contractor</th>
                                <th>Item</th>
                                <th>Unit</th>
                                <th>Agreed Qty</th>
                                <th>Executed Qty</th>
                                <th>Balance Qty</th>
                                <th>Progress %</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody">
                            <tr><td colspan="8" class="empty-state">No progress entries yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Billing Tab -->
            <div id="billing" class="tab-content">
                <div class="section-header">
                    <h2>üí∞ Contractor Billing (RA Bills)</h2>
                    <button class="btn btn-primary" onclick="toggleBillingForm()">+ Add Bill</button>
                </div>

                <div id="billingFormContainer" class="form-toggle">
                    <form id="billingForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Contractor *</label>
                                <select id="billingContractorId" required></select>
                            </div>
                            <div class="form-group">
                                <label>RA Bill No *</label>
                                <input type="text" id="raBillNo" required>
                            </div>
                            <div class="form-group">
                                <label>Bill Period *</label>
                                <input type="text" id="billPeriod" required placeholder="e.g., Jan 2025">
                            </div>
                            <div class="form-group">
                                <label>Measured Quantity *</label>
                                <input type="number" id="measuredQty" required min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Bill Amount (‚Çπ) *</label>
                                <input type="number" id="billAmount" required min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Retention Amount (‚Çπ) *</label>
                                <input type="number" id="retentionAmount" required min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Penalty Amount (‚Çπ)</label>
                                <input type="number" id="penaltyAmount" min="0" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label>Submitted Date *</label>
                                <input type="date" id="submittedDate" required>
                            </div>
                            <div class="form-group">
                                <label>Certified Date</label>
                                <input type="date" id="certifiedDate">
                            </div>
                            <div class="form-group">
                                <label>Payment Status *</label>
                                <select id="paymentStatus" required>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Paid">Paid</option>
                                </select>
                            </div>
                        </div>
                        <div class="highlight-box">
                            <strong>Net Payable: ‚Çπ<span id="netPayable">0</span></strong>
                            <p style="font-size: 12px; margin-top: 5px;">(Bill Amount - Retention - Penalty)</p>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="toggleBillingForm()" style="background: #ccc;">Cancel</button>
                            <button type="submit" class="btn btn-success">üíæ Save Bill</button>
                        </div>
                    </form>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Bill No</th>
                                <th>Contractor</th>
                                <th>Period</th>
                                <th>Bill Amount</th>
                                <th>Retention</th>
                                <th>Penalty</th>
                                <th>Net Payable</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billingTableBody">
                            <tr><td colspan="9" class="empty-state">No bills yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <div class="section-header">
                    <h2>üí≥ Payment Tracking</h2>
                    <button class="btn btn-primary" onclick="togglePaymentForm()">+ Add Payment</button>
                </div>

                <div id="paymentFormContainer" class="form-toggle">
                    <form id="paymentForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Bill *</label>
                                <select id="paymentBillId" required></select>
                            </div>
                            <div class="form-group">
                                <label>Paid Amount (‚Çπ) *</label>
                                <input type="number" id="paidAmount" required min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Payment Date *</label>
                                <input type="date" id="paymentDate" required>
                            </div>
                            <div class="form-group">
                                <label>Payment Mode *</label>
                                <select id="paymentMode" required>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Cash">Cash</option>
                                    <option value="RTGS/NEFT">RTGS/NEFT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Reference No</label>
                                <input type="text" id="referenceNo">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="togglePaymentForm()" style="background: #ccc;">Cancel</button>
                            <button type="submit" class="btn btn-success">üíæ Save Payment</button>
                        </div>
                    </form>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Bill No</th>
                                <th>Contractor</th><invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">super_contractor_complete</parameter>
<parameter name="old_str">                                <th>Contractor</th></parameter>
<parameter name="new_str">                                <th>Contractor</th>
                                <th>Paid Amount</th>
                                <th>Payment Date</th>
                                <th>Mode</th>
                                <th>Balance</th>
                                <th>Delay Days</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <tr><td colspan="7" class="empty-state">No payments yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Quality Tab -->
        <div id="quality" class="tab-content">
            <div class="section-header">
                <h2>‚úÖ Quality & Compliance Tracking</h2>
                <button class="btn btn-primary" onclick="toggleQualityForm()">+ Add Quality Record</button>
            </div>

            <div id="qualityFormContainer" class="form-toggle">
                <form id="qualityForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Select Contractor *</label>
                            <select id="qualityContractorId" required></select>
                        </div>
                        <div class="form-group">
                            <label>Test Type *</label>
                            <select id="testType" required>
                                <option value="Cube Test">Cube Test</option>
                                <option value="Slump Test">Slump Test</option>
                                <option value="Soil Test">Soil Test</option>
                                <option value="Material Test">Material Test</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Test Report No *</label>
                            <input type="text" id="testReportNo" required>
                        </div>
                        <div class="form-group">
                            <label>Inspection Date *</label>
                            <input type="date" id="inspectionDate" required>
                        </div>
                        <div class="form-group">
                            <label>Result *</label>
                            <select id="testResult" required>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Conditional">Conditional</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rework Quantity (if any)</label>
                            <input type="number" id="reworkQty" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Remarks</label>
                            <textarea id="qualityRemarks" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="toggleQualityForm()" style="background: #ccc;">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Save Record</button>
                    </div>
                </form>
            </div>

            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Contractor</th>
                            <th>Test Type</th>
                            <th>Report No</th>
                            <th>Result</th>
                            <th>Rework Qty</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="qualityTableBody">
                        <tr><td colspan="7" class="empty-state">No quality records yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Materials Tab -->
        <div id="materials" class="tab-content">
            <div class="section-header">
                <h2>üì¶ Material Issued to Contractor</h2>
                <button class="btn btn-primary" onclick="toggleMaterialForm()">+ Issue Material</button>
            </div>

            <div id="materialFormContainer" class="form-toggle">
                <form id="materialForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Select Contractor *</label>
                            <select id="materialContractorId" required></select>
                        </div>
                        <div class="form-group">
                            <label>Material Name *</label>
                            <input type="text" id="materialName" required>
                        </div>
                        <div class="form-group">
                            <label>Issued Quantity *</label>
                            <input type="number" id="issuedQty" required min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Unit *</label>
                            <select id="materialUnit" required>
                                <option value="Nos">Nos</option>
                                <option value="MT">MT</option>
                                <option value="Cum">Cum</option>
                                <option value="Sqm">Sqm</option>
                                <option value="Kg">Kg</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rate (‚Çπ) *</label>
                            <input type="number" id="materialRate" required min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Issue Date *</label>
                            <input type="date" id="issueDate" required>
                        </div>
                        <div class="form-group">
                            <label>Recovered from Bill (Qty)</label>
                            <input type="number" id="recoveredQty" min="0" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="highlight-box">
                        <strong>Total Value: ‚Çπ<span id="materialValue">0</span></strong>
                        <br>
                        <strong>Balance Qty: <span id="balanceMaterialQty">0</span></strong>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="toggleMaterialForm()" style="background: #ccc;">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Save Material Issue</button>
                    </div>
                </form>
            </div>

            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Contractor</th>
                            <th>Material</th>
                            <th>Issued Qty</th>
                            <th>Rate</th>
                            <th>Value</th>
                            <th>Recovered</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="materialsTableBody">
                        <tr><td colspan="8" class="empty-state">No material issues yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Profitability Tab -->
        <div id="profitability" class="tab-content">
            <div class="section-header">
                <h2>üíπ Profitability by Contractor</h2>
            </div>

            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Contractor</th>
                            <th>Contract Value</th>
                            <th>Amount Paid</th>
                            <th>Retention Held</th>
                            <th>Penalty</th>
                            <th>Material Cost</th>
                            <th>Delay Cost</th>
                            <th>Net Profit/Loss</th>
                            <th>Profit %</th>
                        </tr>
                    </thead>
                    <tbody id="profitabilityTableBody">
                        <tr><td colspan="9" class="empty-state">No profitability data yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase initialization
    window.addEventListener('load', function() {
        if (typeof firebase === 'undefined') {
            console.error('Firebase not loaded!');
            alert('Firebase connection error. Please refresh the page.');
            return;
        }

        const database = firebase.database();
        
        // Firebase references
        const projectsRef = database.ref('superContractorProjects');
        const contractorsRef = database.ref('contractors');
        const progressRef = database.ref('workProgress');
        const billingRef = database.ref('billing');
        const paymentsRef = database.ref('payments');
        const qualityRef = database.ref('quality');
        const materialsRef = database.ref('materials');

        // Data arrays
        let projects = [];
        let contractors = [];
        let progressEntries = [];
        let bills = [];
        let payments = [];
        let qualityRecords = [];
        let materials = [];

        // Load all data from Firebase
        function loadAllData() {
            projectsRef.on('value', (snap) => {
                const data = snap.val();
                projects = data ? Object.keys(data).map(key => ({firebaseKey: key, ...data[key]})) : [];
                renderProjects();
                updateStats();
                populateProjectDropdowns();
            });

            contractorsRef.on('value', (snap) => {
                const data = snap.val();
                contractors = data ? Object.keys(data).map(key => ({firebaseKey: key, ...data[key]})) : [];
                renderContractors();
                populateContractorDropdowns();
                calculateProfitability();
            });

            progressRef.on('value', (snap) => {
                const data = snap.val();
                progressEntries = data ? Object.keys(data).map(key => ({firebaseKey: key, ...data[key]})) : [];
                renderProgress();
            });

            billingRef.on('value', (snap) => {
                const data = snap.val();
                bills = data ? Object.keys(data).map(key => ({firebaseKey: key, ...data[key]})) : [];
                renderBilling();
                populateBillDropdowns();
            });

            paymentsRef.on('value', (snap) => {
                const data = snap.val();
                payments = data ? Object.keys(data).map(key => ({firebaseKey: key, ...data[key]})) : [];
                renderPayments();
            });

            qualityRef.on('value', (snap) => {
                const data = snap.val();
                qualityRecords = data ? Object.keys(data).map(key => ({firebaseKey: key, ...data[key]})) : [];
                renderQuality();
            });

            materialsRef.on('value', (snap) => {
                const data = snap.val();
                materials = data ? Object.keys(data).map(key => ({firebaseKey: key, ...data[key]})) : [];
                renderMaterials();
            });
        }

        // Helper functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0
            }).format(amount || 0);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-IN');
        }

        // Tab switching
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        };

        // Form toggles
        window.toggleProjectForm = function() {
            document.getElementById('projectFormContainer').classList.toggle('active');
        };

        window.toggleContractorForm = function() {
            document.getElementById('contractorFormContainer').classList.toggle('active');
        };

        window.toggleProgressForm = function() {
            document.getElementById('progressFormContainer').classList.toggle('active');
        };

        window.toggleBillingForm = function() {
            document.getElementById('billingFormContainer').classList.toggle('active');
        };

        window.togglePaymentForm = function() {
            document.getElementById('paymentFormContainer').classList.toggle('active');
        };

        window.toggleQualityForm = function() {
            document.getElementById('qualityFormContainer').classList.toggle('active');
        };

        window.toggleMaterialForm = function() {
            document.getElementById('materialFormContainer').classList.toggle('active');
        };

        // Project form submission
        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const projectData = {
                projectName: document.getElementById('projectName').value,
                clientName: document.getElementById('clientName').value,
                location: document.getElementById('location').value,
                projectValue: parseFloat(document.getElementById('projectValue').value),
                startDate: document.getElementById('startDate').value,
                plannedEndDate: document.getElementById('plannedEndDate').value,
                status: 'Active',
                createdAt: new Date().toISOString(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            projectsRef.push(projectData).then(() => {
                alert('‚úÖ Project added successfully!');
                this.reset();
                toggleProjectForm();
            }).catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        });

        // Contractor form submission
        document.getElementById('contractorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const contractorData = {
                projectId: document.getElementById('contractorProjectId').value,
                contractorName: document.getElementById('contractorName').value,
                workCategory: document.getElementById('workCategory').value,
                agreementNo: document.getElementById('agreementNo').value,
                workOrderDate: document.getElementById('workOrderDate').value,
                contractValue: parseFloat(document.getElementById('contractValue').value),
                rateType: document.getElementById('rateType').value,
                retentionPercent: parseFloat(document.getElementById('retentionPercent').value),
                penaltyPercent: parseFloat(document.getElementById('penaltyPercent').value),
                startDate: document.getElementById('contractorStartDate').value,
                endDate: document.getElementById('contractorEndDate').value,
                status: document.getElementById('contractorStatus').value,
                createdAt: new Date().toISOString(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            contractorsRef.push(contractorData).then(() => {
                alert('‚úÖ Contractor added successfully!');
                this.reset();
                toggleContractorForm();
            }).catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        });

        // Progress form submission
        document.getElementById('progressForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const agreedQty = parseFloat(document.getElementById('agreedQty').value);
            const executedQty = parseFloat(document.getElementById('executedQty').value);
            
            const progressData = {
                contractorId: document.getElementById('progressContractorId').value,
                date: document.getElementById('progressDate').value,
                itemDescription: document.getElementById('itemDescription').value,
                unit: document.getElementById('unit').value,
                agreedQty: agreedQty,
                executedQty: executedQty,
                balanceQty: agreedQty - executedQty,
                progressPercent: ((executedQty / agreedQty) * 100).toFixed(2),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            progressRef.push(progressData).then(() => {
                alert('‚úÖ Progress entry added!');
                this.reset();
                toggleProgressForm();
            }).catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        });

        // Billing form auto-calculate
        document.getElementById('billingForm').addEventListener('input', function() {
            const billAmount = parseFloat(document.getElementById('billAmount').value) || 0;
            const retention = parseFloat(document.getElementById('retentionAmount').value) || 0;
            const penalty = parseFloat(document.getElementById('penaltyAmount').value) || 0;
            const netPayable = billAmount - retention - penalty;
            document.getElementById('netPayable').textContent = netPayable.toFixed(2);
        });

        // Billing form submission
        document.getElementById('billingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const billAmount = parseFloat(document.getElementById('billAmount').value);
            const retention = parseFloat(document.getElementById('retentionAmount').value);
            const penalty = parseFloat(document.getElementById('penaltyAmount').value) || 0;
            
            const billingData = {
                contractorId: document.getElementById('billingContractorId').value,
                raBillNo: document.getElementById('raBillNo').value,
                billPeriod: document.getElementById('billPeriod').value,
                measuredQty: parseFloat(document.getElementById('measuredQty').value),
                billAmount: billAmount,
                retentionAmount: retention,
                penaltyAmount: penalty,
                netPayable: billAmount - retention - penalty,
                submittedDate: document.getElementById('submittedDate').value,
                certifiedDate: document.getElementById('certifiedDate').value || null,
                paymentStatus: document.getElementById('paymentStatus').value,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            billingRef.push(billingData).then(() => {
                alert('‚úÖ Bill added successfully!');
                this.reset();
                toggleBillingForm();
            }).catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        });

        // Payment form submission
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const paymentData = {
                billId: document.getElementById('paymentBillId').value,
                paidAmount: parseFloat(document.getElementById('paidAmount').value),
                paymentDate: document.getElementById('paymentDate').value,
                paymentMode: document.getElementById('paymentMode').value,
                referenceNo: document.getElementById('referenceNo').value,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            paymentsRef.push(paymentData).then(() => {
                alert('‚úÖ Payment recorded!');
                this.reset();
                togglePaymentForm();
            }).catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        });

        // Quality form submission
        document.getElementById('qualityForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const qualityData = {
                contractorId: document.getElementById('qualityContractorId').value,
                testType: document.getElementById('testType').value,
                testReportNo: document.getElementById('testReportNo').value,
                inspectionDate: document.getElementById('inspectionDate').value,
                result: document.getElementById('testResult').value,
                reworkQty: parseFloat(document.getElementById('reworkQty').value) || 0,
                remarks: document.getElementById('qualityRemarks').value,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            qualityRef.push(qualityData).then(() => {
                alert('‚úÖ Quality record added!');
                this.reset();
                toggleQualityForm();
            }).catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        });

        // Material form auto-calculate
        document.getElementById('materialForm').addEventListener('input', function() {
            const qty = parseFloat(document.getElementById('issuedQty').value) || 0;
            const rate = parseFloat(document.getElementById('materialRate').value) || 0;
            const recovered = parseFloat(document.getElementById('recoveredQty').value) || 0;
            
            document.getElementById('materialValue').textContent = (qty * rate).toFixed(2);
            document.getElementById('balanceMaterialQty').textContent = (qty - recovered).toFixed(2);
        });

        // Material form submission
        document.getElementById('materialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const issuedQty = parseFloat(document.getElementById('issuedQty').value);
            const rate = parseFloat(document.getElementById('materialRate').value);
            const recoveredQty = parseFloat(document.getElementById('recoveredQty').value) || 0;
            
            const materialData = {
                contractorId: document.getElementById('materialContractorId').value,
                materialName: document.getElementById('materialName').value,
                issuedQty: issuedQty,
                unit: document.getElementById('materialUnit').value,
                rate: rate,
                value: issuedQty * rate,
                issueDate: document.getElementById('issueDate').value,
                recoveredQty: recoveredQty,
                balanceQty: issuedQty - recoveredQty,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            materialsRef.push(materialData).then(() => {
                alert('‚úÖ Material issue recorded!');
                this.reset();
                toggleMaterialForm();
            }).catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        });

        // Render functions
        function renderProjects() {
            const tbody = document.getElementById('projectsTableBody');
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No projects yet</td></tr>';
                return;
            }

            tbody.innerHTML = projects.map(p => {
                const totalBilled = bills.filter(b => b.projectId === p.firebaseKey).reduce((sum, b) => sum + b.billAmount, 0);
                const totalPaid = payments.reduce((sum, pay) => {
                    const bill = bills.find(b => b.firebaseKey === pay.billId);
                    return bill && bill.projectId === p.firebaseKey ? sum + pay.paidAmount : sum;
                }, 0);
                const progress = progressEntries.filter(pr => pr.projectId === p.firebaseKey);
                const avgProgress = progress.length > 0 ? (progress.reduce((sum, pr) => sum + parseFloat(pr.progressPercent), 0) / progress.length).toFixed(1) : 0;

                return `
                    <tr>
                        <td><strong>${p.projectName}</strong></td>
                        <td>${p.clientName}</td>
                        <td>${formatCurrency(p.projectValue)}</td>
                        <td>${avgProgress}%</td>
                        <td>${formatCurrency(totalBilled)}</td>
                        <td>${formatCurrency(totalPaid)}</td>
                        <td>${formatCurrency(totalBilled - totalPaid)}</td>
                        <td><span class="badge badge-${p.status === 'Active' ? 'success' : 'info'}">${p.status}</span></td>
                        <td>
                            <button class="btn btn-warning" onclick="viewProject('${p.firebaseKey}')">View</button>
                            <button class="btn btn-danger" onclick="deleteProject('${p.firebaseKey}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderContractors() {
            const tbody = document.getElementById('contractorsTableBody');
            if (contractors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No contractors yet</td></tr>';
                return;
            }

            tbody.innerHTML = contractors.map(c => {
                const project = projects.find(p => p.firebaseKey === c.projectId);
                return `
                    <tr>
                        <td><strong>${c.contractorName}</strong></td>
                        <td>${project ? project.projectName : 'N/A'}</td>
                        <td>${c.workCategory}</td>
                        <td>${formatCurrency(c.contractValue)}</td>
                        <td>${c.agreementNo}</td>
                        <td>${c.retentionPercent}%</td>
                        <td><span class="badge badge-${c.status === 'Active' ? 'success' : c.status === 'Completed' ? 'info' : 'danger'}">${c.status}</span></td>
                        <td>
                            <button class="btn btn-warning" onclick="viewContractor('${c.firebaseKey}')">View</button>
                            <button class="btn btn-danger" onclick="deleteContractor('${c.firebaseKey}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderProgress() {
            const tbody = document.getElementById('progressTableBody');
            if (progressEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No progress entries yet</td></tr>';
                return;
            }

            tbody.innerHTML = progressEntries.map(p => {
                const contractor = contractors.find(c => c.firebaseKey === p.contractorId);
                return `
                    <tr>
                        <td>${formatDate(p.date)}</td>
                        <td>${contractor ? contractor.contractorName : 'N/A'}</td>
                        <td>${p.itemDescription}</td>
                        <td>${p.unit}</td>
                        <td>${p.agreedQty}</td>
                        <td>${p.executedQty}</td>
                        <td>${p.balanceQty}</td>
                        <td><span class="badge badge-${p.progressPercent >= 100 ? 'success' : p.progressPercent >= 50 ? 'warning' : 'danger'}">${p.progressPercent}%</span></td>
                    </tr>
                `;
            }).join('');
        }

        function renderBilling() {
            const tbody = document.getElementById('billingTableBody');
            if (bills.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No bills yet</td></tr>';
                return;
            }

            tbody.innerHTML = bills.map(b => {
                const contractor = contractors.find(c => c.firebaseKey === b.contractorId);
                return `
                    <tr>
                        <td><strong>${b.raBillNo}</strong></td>
                        <td>${contractor ? contractor.contractorName : 'N/A'}</td>
                        <td>${b.billPeriod}</td>
                        <td>${formatCurrency(b.billAmount)}</td>
                        <td>${formatCurrency(b.retentionAmount)}</td>
                        <td>${formatCurrency(b.penaltyAmount)}</td>
                        <td><strong>${formatCurrency(b.netPayable)}</strong></td>
                        <td><span class="badge badge-${b.paymentStatus === 'Paid' ? 'success' : b.paymentStatus === 'Approved' ? 'warning' : 'danger'}">${b.paymentStatus}</span></td>
                        <td>
                            <button class="btn btn-warning" onclick="viewBill('${b.firebaseKey}')">View</button>
                            <button class="btn btn-danger" onclick="deleteBill('${b.firebaseKey}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPayments() {
            const tbody = document.getElementById('paymentsTableBody');
            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No payments yet</td></tr>';
                return;
            }

            tbody.innerHTML = payments.map(p => {
                const bill = bills.find(b => b.firebaseKey === p.billId);
                const contractor = bill ? contractors.find(c => c.firebaseKey === bill.contractorId) : null;
                const balance = bill ? bill.netPayable - p.paidAmount : 0;
                const delayDays = bill ? Math.floor((new Date(p.paymentDate) - new Date(bill.submittedDate)) / (1000 * 60 * 60 * 24)) : 0;

                return `
                    <tr>
                        <td>${bill ? bill.raBillNo : 'N/A'}</td>
                        <td>${contractor ? contractor.contractorName : 'N/A'}</td>
                        <td>${formatCurrency(p.paidAmount)}</td>
                        <td>${formatDate(p.paymentDate)}</td>
                        <td>${p.paymentMode}</td>
                        <td>${formatCurrency(balance)}</td>
                        <td><span class="badge badge-${delayDays > 30 ? 'danger' : delayDays > 15 ? 'warning' : 'success'}">${delayDays} days</span></td>
                    </tr>
                `;
            }).join('');
        }

        function renderQuality() {
            const tbody = document.getElementById('qualityTableBody');
            if (qualityRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No quality records yet</td></tr>';
                return;
            }

            tbody.innerHTML = qualityRecords.map(q => {
                const contractor = contractors.find(c => c.firebaseKey === q.contractorId);
                return `
                    <tr>
                        <td>${formatDate(q.inspectionDate)}</td>
                        <td>${contractor ? contractor.contractorName : 'N/A'}</td>
                        <td>${q.testType}</td>
                        <td>${q.testReportNo}</td>
                        <td><span class="badge badge-${q.result === 'Approved' ? 'success' : q.result === 'Conditional' ? 'warning' : 'danger'}">${q.result}</span></td>
                        <td>${q.reworkQty}</td>
<td>${q.remarks || '-'}</td>
</tr>
`;
}).join('');
}function renderMaterials() {
            const tbody = document.getElementById('materialsTableBody');
            if (materials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No material issues yet</td></tr>';
                return;
            }

            tbody.innerHTML = materials.map(m => {
                const contractor = contractors.find(c => c.firebaseKey === m.contractorId);
                return `
                    <tr>
                        <td>${formatDate(m.issueDate)}</td>
                        <td>${contractor ? contractor.contractorName : 'N/A'}</td>
                        <td>${m.materialName}</td>
                        <td>${m.issuedQty} ${m.unit}</td>
                        <td>${formatCurrency(m.rate)}</td>
                        <td>${formatCurrency(m.value)}</td>
                        <td>${m.recoveredQty} ${m.unit}</td>
                        <td>${m.balanceQty} ${m.unit}</td>
                    </tr>
                `;
            }).join('');
        }

        function calculateProfitability() {
            const tbody = document.getElementById('profitabilityTableBody');
            if (contractors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No profitability data yet</td></tr>';
                return;
            }

            tbody.innerHTML = contractors.map(c => {
                const contractorBills = bills.filter(b => b.contractorId === c.firebaseKey);
                const totalPaid = payments.filter(p => {
                    const bill = bills.find(b => b.firebaseKey === p.billId);
                    return bill && bill.contractorId === c.firebaseKey;
                }).reduce((sum, p) => sum + p.paidAmount, 0);
                
                const totalRetention = contractorBills.reduce((sum, b) => sum + b.retentionAmount, 0);
                const totalPenalty = contractorBills.reduce((sum, b) => sum + b.penaltyAmount, 0);
                const materialCost = materials.filter(m => m.contractorId === c.firebaseKey).reduce((sum, m) => sum + m.value, 0);
                
                const delayCost = totalPenalty;
                const netProfit = c.contractValue - totalPaid - materialCost;
                const profitPercent = ((netProfit / c.contractValue) * 100).toFixed(2);

                return `
                    <tr>
                        <td><strong>${c.contractorName}</strong></td>
                        <td>${formatCurrency(c.contractValue)}</td>
                        <td>${formatCurrency(totalPaid)}</td>
                        <td>${formatCurrency(totalRetention)}</td>
                        <td>${formatCurrency(totalPenalty)}</td>
                        <td>${formatCurrency(materialCost)}</td>
                        <td>${formatCurrency(delayCost)}</td>
                        <td><strong class="${netProfit >= 0 ? 'badge-success' : 'badge-danger'}">${formatCurrency(netProfit)}</strong></td>
                        <td><span class="badge badge-${netProfit >= 0 ? 'success' : 'danger'}">${profitPercent}%</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            const totalProjectValue = projects.reduce((sum, p) => sum + p.projectValue, 0);
            const totalBilled = bills.reduce((sum, b) => sum + b.billAmount, 0);
            const totalPaid = payments.reduce((sum, p) => sum + p.paidAmount, 0);
            const totalProfit = contractors.reduce((sum, c) => {
                const paid = payments.filter(p => {
                    const bill = bills.find(b => b.firebaseKey === p.billId);
                    return bill && bill.contractorId === c.firebaseKey;
                }).reduce((s, p) => s + p.paidAmount, 0);
                return sum + (c.contractValue - paid);
            }, 0);

            const avgProgress = progressEntries.length > 0 
                ? (progressEntries.reduce((sum, p) => sum + parseFloat(p.progressPercent), 0) / progressEntries.length).toFixed(1)
                : 0;

            const avgDelay = payments.length > 0
                ? Math.floor(payments.reduce((sum, p) => {
                    const bill = bills.find(b => b.firebaseKey === p.billId);
                    return sum + (bill ? Math.floor((new Date(p.paymentDate) - new Date(bill.submittedDate)) / (1000 * 60 * 60 * 24)) : 0);
                }, 0) / payments.length)
                : 0;

            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('totalProjectValue').textContent = formatCurrency(totalProjectValue);
            document.getElementById('avgProgress').textContent = avgProgress + '%';
            document.getElementById('totalBilled').textContent = formatCurrency(totalBilled);
            document.getElementById('totalPaid').textContent = formatCurrency(totalPaid);
            document.getElementById('balancePayable').textContent = formatCurrency(totalBilled - totalPaid);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('avgDelay').textContent = avgDelay;
        }

        function populateProjectDropdowns() {
            const select = document.getElementById('contractorProjectId');
            select.innerHTML = '<option value="">Select Project</option>' +
                projects.map(p => `<option value="${p.firebaseKey}">${p.projectName}</option>`).join('');
        }

        function populateContractorDropdowns() {
            const selects = ['progressContractorId', 'billingContractorId', 'qualityContractorId', 'materialContractorId'];
            const options = '<option value="">Select Contractor</option>' +
                contractors.map(c => `<option value="${c.firebaseKey}">${c.contractorName} - ${c.workCategory}</option>`).join('');
            
            selects.forEach(id => {
                document.getElementById(id).innerHTML = options;
            });
        }

        function populateBillDropdowns() {
            const select = document.getElementById('paymentBillId');
            select.innerHTML = '<option value="">Select Bill</option>' +
                bills.map(b => {
                    const contractor = contractors.find(c => c.firebaseKey === b.contractorId);
                    return `<option value="${b.firebaseKey}">${b.raBillNo} - ${contractor ? contractor.contractorName : 'N/A'} - ${formatCurrency(b.netPayable)}</option>`;
                }).join('');
        }

        window.goBackToDashboard = function() {
            window.location.href = 'index.html';
        };

        window.deleteProject = function(key) {
            if (confirm('Delete this project? This will delete all related data.')) {
                projectsRef.child(key).remove();
            }
        };

        window.deleteContractor = function(key) {
            if (confirm('Delete this contractor?')) {
                contractorsRef.child(key).remove();
            }
        };

        window.deleteBill = function(key) {
            if (confirm('Delete this bill?')) {
                billingRef.child(key).remove();
            }
        };

        // Initialize
        loadAllData();
    });
</script>
</body>
</parameter>
</html>